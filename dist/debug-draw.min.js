(function(t,e,i,s){"use strict";i="default"in i?i["default"]:i;s="default"in s?s["default"]:s;let r=10;let a=10;let n=e.vec3.new(0,0,-1);let h=e.vec3.new(1,0,0);let o=e.vec3.new(0,1,0);let _=e.quat.create();let c=e.quat.create();let d=e.quat.create();let u=e.mat3.create();let p=e.vec3.create();let f=e.vec3.create();let l=e.vec3.create();let m=e.vec3.create();let w=e.vec3.create();class v{constructor(t,i){i=i||{};i.theta=i.theta||0;i.phi=i.phi||0;i.eye=i.eye||e.vec3.new(0,0,0);i.near=i.near||.01;i.far=i.far||1e3;this._props=i;this._cache={view:new Float32Array(16),proj:new Float32Array(16)};this._input=t;this._view=e.mat4.create();this._proj=e.mat4.create();this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;this._curTheta=i.theta;this._curPhi=i.phi;this._curEye=e.vec3.clone(i.eye);this._theta=i.theta;this._phi=i.phi;this._eye=e.vec3.clone(i.eye)}tick(t,i,s){this._handleInput();this._calcView(t);this._calcProj(i,s);e.mat4.array(this._cache.view,this._view);e.mat4.array(this._cache.proj,this._proj)}_handleInput(){let t=this._input;this._df=0;this._dr=0;this._panX=0;this._panY=0;this._panZ=0;if(t.mousepress("left")&&t.mousepress("right")){let e=t.mouseDeltaX;let i=t.mouseDeltaY;this._panX=e;this._panY=-i}else if(t.mousepress("left")){let e=t.mouseDeltaX;let i=t.mouseDeltaY;this._theta-=e*.002;this._panZ=-i}else if(t.mousepress("right")){let e=t.mouseDeltaX;let i=t.mouseDeltaY;this._theta-=e*.002;this._phi-=i*.002}if(t.keypress("w")){this._df+=1}if(t.keypress("s")){this._df-=1}if(t.keypress("a")){this._dr-=1}if(t.keypress("d")){this._dr+=1}if(t.mouseScrollY){this._df-=t.mouseScrollY*.05}}_calcView(t){this._curPhi=e.lerp(this._curPhi,this._phi,t*r);this._curTheta=e.lerp(this._curTheta,this._theta,t*r);let i=this._eye;let s=this._curPhi;let v=this._curTheta;let y=this._panX;let g=this._panY;let A=this._panZ;e.quat.identity(c);e.quat.identity(d);e.quat.rotateX(c,c,s);e.quat.rotateY(d,d,v);e.quat.mul(_,d,c);e.mat3.fromQuat(u,_);e.vec3.transformMat3(p,n,u);e.vec3.transformMat3(l,o,u);e.vec3.transformMat3(f,h,u);if(this._df!==0){e.vec3.scaleAndAdd(i,i,p,this._df*t*a)}if(this._dr!==0){e.vec3.scaleAndAdd(i,i,f,this._dr*t*a)}if(A!==0){e.vec3.copy(m,p);m.y=0;e.vec3.normalize(m,m);e.vec3.scaleAndAdd(i,i,m,A*t*a)}if(y!==0){e.vec3.copy(w,f);w.y=0;e.vec3.normalize(w,w);e.vec3.scaleAndAdd(i,i,w,y*t*a)}if(g!==0){e.vec3.scaleAndAdd(i,i,o,g*t*a)}e.vec3.lerp(this._curEye,this._curEye,i,t*r);e.mat4.lookAt(this._view,this._curEye,e.vec3.scaleAndAdd(m,this._curEye,p,1),l)}_calcProj(t,i){e.mat4.perspective(this._proj,Math.PI/4,t/i,this._props.near,this._props.far)}}function y(t){return t({uniforms:{view:t.prop("view"),projection:t.prop("projection")}})}function g(t,i,s,r){let a=[];let n=e.mat4.array(new Float32Array(16),e.mat4.create());let h=i*.5;let o=s*.5;let _=i/r;let c=s/r;for(let t=-h;t<=h;t+=_){a.push(t,0,-o);a.push(t,0,o)}for(let t=-o;t<=o;t+=c){a.push(-h,0,t);a.push(h,0,t)}return t({blend:{enable:true,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]},vert:`
      precision mediump float;
      uniform mat4 model, view, projection;

      attribute vec3 a_pos;

      void main() {
        vec4 pos = projection * view * model * vec4(a_pos, 1);

        gl_Position = pos;
      }
    `,frag:`
      precision mediump float;

      void main () {
        gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
      }
    `,primitive:"lines",attributes:{a_pos:a},uniforms:{model:n},count:a.length/3})}function A(t){let i=t({vert:`
      precision mediump float;
      uniform mat4 model, view, projection;

      attribute vec3 a_pos;
      attribute vec3 a_color;

      varying vec3 color;

      void main() {
        vec4 pos = projection * view * model * vec4(a_pos, 1);

        gl_Position = pos;
        color = a_color;
      }
    `,frag:`
      precision mediump float;
      varying vec3 color;

      void main () {
        gl_FragColor = vec4(color, 1.0);
      }
    `,primitive:"lines",attributes:{a_pos:t.prop("lines"),a_color:t.prop("colors")},uniforms:{model:t.prop("transform")},count:t.prop("count")});const s=e.mat4.array(new Float32Array(16),e.mat4.create());return function(t){t=t||s;i({transform:t,lines:[[0,0,0],[.5,0,0],[0,0,0],[0,.5,0],[0,0,0],[0,0,.5]],colors:[[1,0,0],[.5,0,0],[0,1,0],[0,.5,0],[0,0,1],[0,0,.5]],count:6})}}function C(t){let i=e.mat4.array(new Float32Array(16),e.mat4.create());return t({vert:`
      precision mediump float;
      uniform mat4 model, view, projection;

      attribute vec3 a_pos;

      void main() {
        vec4 pos = projection * view * vec4(a_pos, 1);

        gl_Position = pos;
      }
    `,frag:`
      precision mediump float;

      void main () {
        gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
      }
    `,primitive:"lines",attributes:{a_pos:t.prop("line")},count:2})}let E=e.mat4.create();let P=new Float32Array(16);class b{constructor(t){this._canvasEL=t;this._regl=i({canvas:t,extensions:["webgl_depth_texture","OES_texture_float","OES_texture_float_linear","OES_standard_derivatives"]});this._uniforms={};this._common=y(this._regl);this._drawGrid=g(this._regl,100,100,100);this._drawCoord=A(this._regl);this._drawLine=C(this._regl);this._nodes=[];this._nodesCnt=0;this._destPosList=[];this._destPosCnt=0;this._draws=[];this._drawsCnt=0}resize(){let t=this._canvasEL.parentElement.getBoundingClientRect();this._canvasEL.width=t.width;this._canvasEL.height=t.height}setUniform(t,e){this._uniforms[t]=e}drawNode(t){this._nodes[this._nodesCnt]=t;this._nodesCnt++}drawDestPos(t){this._destPosList[this._destPosCnt]=t;this._destPosCnt++}addCommand(t,e){this._draws[this._drawsCnt]={cmd:t,data:e};this._drawsCnt++}frame(t){this._regl.frame(i=>{this._reset();if(t){t(i)}this._regl.clear({color:[.3,.3,.3,1],depth:1});this._common(this._uniforms,()=>{for(let t=0;t<this._drawsCnt;++t){let e=this._draws[t];e.cmd(e.data)}for(let t=0;t<this._nodesCnt;++t){let i=this._nodes[t];i._getWorldRT(E);e.mat4.array(P,E);this._drawCoord(P)}for(let t=0;t<this._destPosCnt;++t){let e=this._destPosList[t];this._drawLine({line:[[e.x,e.y,e.z],[e.x,e.y+1,e.z]]})}this._drawGrid()})})}_reset(){this._drawsCnt=0;this._nodesCnt=0;this._destPosCnt=0}}class L{constructor(t){this._renderer=new b(t);this._input=new s(t,{lock:true});this._orbit=new v(this._input,{eye:e.vec3.new(0,5,10),phi:e.toRadian(-30)});this._last=0;this._dt=0;this._time=0;window.addEventListener("resize",()=>{this.resize()});window.requestAnimationFrame(()=>{this.resize()})}frame(t){this._renderer.frame(({time:time,viewportWidth:viewportWidth,viewportHeight:viewportHeight})=>{let e=time-this._last;this._last=time;this._dt=e;this._time=time;if(t){t()}this._orbit.tick(e,viewportWidth,viewportHeight);this._renderer.setUniform("view",this._orbit._cache.view);this._renderer.setUniform("projection",this._orbit._cache.proj);this._input.reset()})}resize(){this._renderer.resize();this._input.resize()}}t.Orbit=v;t.Renderer=b;t.Shell=L})(this.ddraw=this.ddraw||{},window.vmath,window.createREGL,window.Input);
//# sourceMappingURL=./dist/debug-draw.min.js.map